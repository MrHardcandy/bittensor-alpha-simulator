name: ç­–ç•¥å»¶è¿Ÿæ—¶é—´å¯¹ROIå½±å“æµ‹è¯•

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      test_description:
        description: 'æµ‹è¯•æè¿°'
        required: false
        default: 'ç­–ç•¥å»¶è¿Ÿæ—¶é—´å½±å“æµ‹è¯•'
  
  # æ¯å‘¨æ—¥è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 2 * * 0'

jobs:
  strategy-delay-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install matplotlib seaborn
    
    - name: ğŸ” è¿è¡Œç­–ç•¥å»¶è¿Ÿæµ‹è¯•
      run: |
        echo "å¼€å§‹ç­–ç•¥å»¶è¿Ÿæµ‹è¯•..."
        python scripts/strategy_delay_test.py
        echo "æµ‹è¯•å®Œæˆï¼"
    
    - name: ğŸ“Š ç”ŸæˆHTMLæŠ¥å‘Š
      run: |
        echo "ç”ŸæˆHTMLæŠ¥å‘Š..."
        python scripts/generate_report.py
        echo "æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼"
    
    - name: ğŸ“‹ æ˜¾ç¤ºæµ‹è¯•æ‘˜è¦
      run: |
        echo "=== æµ‹è¯•ç»“æœæ‘˜è¦ ==="
        if [ -f test_results/test_summary_*.json ]; then
          latest_summary=$(ls -t test_results/test_summary_*.json | head -1)
          echo "ğŸ“„ æ‘˜è¦æ–‡ä»¶: $latest_summary"
          cat "$latest_summary"
        else
          echo "âš ï¸  æœªæ‰¾åˆ°æµ‹è¯•æ‘˜è¦æ–‡ä»¶"
        fi
        
        echo ""
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
        ls -la test_results/
    
    - name: ğŸ’¾ ä¸Šä¼ æµ‹è¯•ç»“æœ (Artifacts)
      uses: actions/upload-artifact@v4
      with:
        name: strategy-delay-test-results-${{ github.run_number }}
        path: |
          test_results/*.csv
          test_results/*.json
          test_results/*.html
        retention-days: 30
    
    - name: ğŸŒ éƒ¨ç½²åˆ°GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./test_results
        destination_dir: strategy-delay-reports
        keep_files: false
        commit_message: "ğŸ“Š æ›´æ–°ç­–ç•¥å»¶è¿Ÿæµ‹è¯•æŠ¥å‘Š - Run #${{ github.run_number }}"
    
    - name: ğŸ’¬ åˆ›å»ºIssueæŠ¥å‘Š
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // è¯»å–æµ‹è¯•æ‘˜è¦
          let summary = {};
          try {
            const summaryFiles = fs.readdirSync('test_results').filter(f => f.startsWith('test_summary_'));
            if (summaryFiles.length > 0) {
              const latestSummary = summaryFiles.sort().pop();
              summary = JSON.parse(fs.readFileSync(`test_results/${latestSummary}`, 'utf8'));
            }
          } catch (error) {
            console.log('æ— æ³•è¯»å–æµ‹è¯•æ‘˜è¦:', error);
          }
          
          const runNumber = context.runNumber;
          const workflowUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
          const pagesUrl = `${context.payload.repository.html_url}/blob/gh-pages/strategy-delay-reports/index.html`;
          const triggerType = context.eventName === 'workflow_dispatch' ? 'Manual' : 'Scheduled';
          
          const issueBody = `
          ## ğŸ¯ ç­–ç•¥å»¶è¿Ÿæ—¶é—´å¯¹ROIå½±å“æµ‹è¯•æŠ¥å‘Š #${runNumber}
          
          **æµ‹è¯•æ—¶é—´:** ${new Date().toISOString()}
          **è§¦å‘æ–¹å¼:** ${triggerType}
          
          ### ğŸ“Š æµ‹è¯•ç»“æœæ‘˜è¦
          
          ${summary.total_tests ? `
          - **æ€»æµ‹è¯•æ¬¡æ•°:** ${summary.total_tests}
          - **åœºæ™¯Aæµ‹è¯•:** ${summary.scenario_a_tests} (1000 TAO)
          - **åœºæ™¯Bæµ‹è¯•:** ${summary.scenario_b_tests} (2000 TAO)
          
          ### ğŸ† æœ€ä¼˜ç»“æœ
          
          **åœºæ™¯A (1000 TAO):**
          - æœ€ä½³å»¶è¿Ÿæ—¶é—´: ${summary.scenario_a_best_roi?.delay_days} å¤©
          - æœ€é«˜ROI: ${summary.scenario_a_best_roi?.roi_percent?.toFixed(2)}%
          
          **åœºæ™¯B (2000 TAO):**
          - æœ€ä½³å»¶è¿Ÿæ—¶é—´: ${summary.scenario_b_best_roi?.delay_days} å¤©  
          - æœ€é«˜ROI: ${summary.scenario_b_best_roi?.roi_percent?.toFixed(2)}%
          ` : 'æµ‹è¯•æ•°æ®è¯»å–å¤±è´¥'}
          
          ### ğŸ“ æŸ¥çœ‹ç»“æœ
          
          - ğŸŒ [åœ¨çº¿æŠ¥å‘Š](${pagesUrl})
          - ğŸ“¥ [ä¸‹è½½åŸå§‹æ•°æ®](${workflowUrl}) (Artifacts)
          - ğŸ”§ [å·¥ä½œæµè¯¦æƒ…](${workflowUrl})
          
          ### ğŸ“‹ ä½¿ç”¨è¯´æ˜
          
          1. **åœ¨çº¿æŸ¥çœ‹:** ç‚¹å‡»ä¸Šæ–¹"åœ¨çº¿æŠ¥å‘Š"é“¾æ¥æŸ¥çœ‹è¯¦ç»†çš„å¯è§†åŒ–æŠ¥å‘Š
          2. **ä¸‹è½½æ•°æ®:** åœ¨å·¥ä½œæµé¡µé¢ä¸‹è½½Artifactsè·å–CSVå’ŒJSONåŸå§‹æ•°æ®
          3. **å†å²å¯¹æ¯”:** æŸ¥çœ‹ä¹‹å‰çš„Issueäº†è§£å†å²æµ‹è¯•ç»“æœ
          
          ---
          ğŸ¤– æ­¤æŠ¥å‘Šç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ
          `;
          
          // åˆ›å»ºIssue
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ“Š ç­–ç•¥å»¶è¿Ÿæµ‹è¯•æŠ¥å‘Š #${runNumber} - ${new Date().toISOString().split('T')[0]}`,
            body: issueBody,
            labels: ['automated-test', 'strategy-analysis']
          });
    
    - name: âœ… æµ‹è¯•å®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ ç­–ç•¥å»¶è¿Ÿæ—¶é—´å¯¹ROIå½±å“æµ‹è¯•å·²å®Œæˆï¼"
        echo ""
        echo "ğŸ“Š ç»“æœæŸ¥çœ‹æ–¹å¼:"
        echo "1. åœ¨çº¿æŠ¥å‘Š: GitHub Pages (strategy-delay-reports)"
        echo "2. åŸå§‹æ•°æ®: Actions Artifacts"
        echo "3. æ‘˜è¦æŠ¥å‘Š: è‡ªåŠ¨åˆ›å»ºçš„Issue"
        echo ""
        echo "ğŸ’¡ æç¤º: æŠ¥å‘Šå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ‰èƒ½åœ¨GitHub Pagesä¸Šæ›´æ–°"